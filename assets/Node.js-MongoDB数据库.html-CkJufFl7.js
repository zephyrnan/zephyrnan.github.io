import{_ as l,c,a as i,b as s,d as p,e as a,w as u,r as e,o as r}from"./app-DiRdVEu8.js";const d={};function k(m,n){const t=e("RouteLink"),o=e("comment-section");return r(),c("div",null,[n[4]||(n[4]=i(`<h1 id="node-js-mongodb-ç”Ÿäº§çº§æœ€ä½³å®è·µæŒ‡å—" tabindex="-1"><a class="header-anchor" href="#node-js-mongodb-ç”Ÿäº§çº§æœ€ä½³å®è·µæŒ‡å—"><span>Node.js + MongoDB ç”Ÿäº§çº§æœ€ä½³å®è·µæŒ‡å—</span></a></h1><h2 id="_1-mongodb-ç®€ä»‹ä¸æ ¸å¿ƒæ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#_1-mongodb-ç®€ä»‹ä¸æ ¸å¿ƒæ¦‚å¿µ"><span>1. MongoDB ç®€ä»‹ä¸æ ¸å¿ƒæ¦‚å¿µ</span></a></h2><p>MongoDB æ˜¯ä¸€ä¸ªåŸºäºåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨çš„æ•°æ®åº“ï¼Œæ ¸å¿ƒä¼˜åŠ¿åœ¨äºçµæ´»çš„æ–‡æ¡£æ¨¡å‹ï¼ˆJSON-likeï¼‰å’Œæ¨ªå‘æ‰©å±•èƒ½åŠ›ã€‚</p><h3 id="æ ¸å¿ƒæ˜ å°„å…³ç³»" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒæ˜ å°„å…³ç³»"><span>æ ¸å¿ƒæ˜ å°„å…³ç³»</span></a></h3><table><thead><tr><th style="text-align:left;">SQL æ¦‚å¿µ</th><th style="text-align:left;">MongoDB æ¦‚å¿µ</th><th style="text-align:left;">å…³é”®å·®å¼‚</th></tr></thead><tbody><tr><td style="text-align:left;">Database</td><td style="text-align:left;">Database</td><td style="text-align:left;">æ•°æ®åº“</td></tr><tr><td style="text-align:left;">Table</td><td style="text-align:left;"><strong>Collection é›†åˆ</strong></td><td style="text-align:left;">é›†åˆï¼ˆæ— å¼ºåˆ¶æ¨¡å¼ï¼Œä½†åœ¨åº”ç”¨å±‚é€šå¸¸æœ‰æ¨¡å¼ï¼‰</td></tr><tr><td style="text-align:left;">Row è¡Œ</td><td style="text-align:left;"><strong>Document æ–‡æ¡£</strong></td><td style="text-align:left;">æ–‡æ¡£ï¼ˆBSON æ ¼å¼ï¼Œæœ€å¤§ 16MBï¼‰</td></tr><tr><td style="text-align:left;">Column åˆ—</td><td style="text-align:left;"><strong>Field åœº</strong></td><td style="text-align:left;">å­—æ®µ</td></tr><tr><td style="text-align:left;">Primary Key</td><td style="text-align:left;"><strong>_id</strong></td><td style="text-align:left;">é»˜è®¤ä¸»é”®ï¼ˆObjectIdï¼Œè‡ªåŠ¨ç”Ÿæˆï¼Œå¸¦æ—¶é—´æˆ³ï¼‰</td></tr></tbody></table><hr><h2 id="_2-æ•°æ®åº“è¿æ¥-å•ä¾‹æ¨¡å¼-è¿™æ˜¯é‡ç‚¹" tabindex="-1"><a class="header-anchor" href="#_2-æ•°æ®åº“è¿æ¥-å•ä¾‹æ¨¡å¼-è¿™æ˜¯é‡ç‚¹"><span>2. æ•°æ®åº“è¿æ¥ï¼šå•ä¾‹æ¨¡å¼ (è¿™æ˜¯é‡ç‚¹)</span></a></h2><p>åœ¨ Web åº”ç”¨ï¼ˆExpress/Koa/NestJSï¼‰ä¸­ï¼Œ<strong>åˆ‡å‹¿</strong>åœ¨ API è·¯ç”±ä¸­è¿æ¥æ•°æ®åº“ã€‚åº”è¯¥åœ¨åº”ç”¨å¯åŠ¨æ—¶è¿æ¥ä¸€æ¬¡ï¼Œå¹¶åœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå¤ç”¨ã€‚</p><h3 id="_2-1-æ¨èç›®å½•ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_2-1-æ¨èç›®å½•ç»“æ„"><span>2.1 æ¨èç›®å½•ç»“æ„</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">src/</span>
<span class="line">â”œâ”€â”€ config/</span>
<span class="line">â”‚   â””â”€â”€ db.js        &lt;-- æ•°æ®åº“è¿æ¥æ¨¡å—</span>
<span class="line">â”œâ”€â”€ models/          &lt;-- Mongoose æ¨¡å‹å®šä¹‰</span>
<span class="line">â”œâ”€â”€ app.js           &lt;-- å…¥å£æ–‡ä»¶</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-é…ç½®æ–‡ä»¶-config-db-js" tabindex="-1"><a class="header-anchor" href="#_2-2-é…ç½®æ–‡ä»¶-config-db-js"><span>2.2 é…ç½®æ–‡ä»¶ (config/db.js)</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;mongoose&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">connectDB</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// Mongoose 6+ ä¸éœ€è¦ useNewUrlParser ç­‰åºŸå¼ƒé€‰é¡¹</span></span>
<span class="line">    <span class="token keyword">const</span> conn <span class="token operator">=</span> <span class="token keyword">await</span> mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MONGODB_URI</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// ç”Ÿäº§ç¯å¢ƒå»ºè®®é…ç½®è¿æ¥æ± </span></span>
<span class="line">      <span class="token literal-property property">maxPoolSize</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> </span>
<span class="line">      <span class="token literal-property property">serverSelectionTimeoutMS</span><span class="token operator">:</span> <span class="token number">5000</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">socketTimeoutMS</span><span class="token operator">:</span> <span class="token number">45000</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">MongoDB Connected: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>conn<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è¿æ¥å¤±è´¥åˆ™ç»ˆæ­¢è¿›ç¨‹</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> connectDB<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-å…¥å£æ–‡ä»¶-app-js" tabindex="-1"><a class="header-anchor" href="#_2-3-å…¥å£æ–‡ä»¶-app-js"><span>2.3 å…¥å£æ–‡ä»¶ (app.js)</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;express&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> connectDB <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./config/db&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;dotenv&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 1. å…ˆè¿æ¥æ•°æ®åº“</span></span>
<span class="line"><span class="token function">connectDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 2. å†å¯åŠ¨æœåŠ¡å™¨</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Server running on port 3000&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="_3-mongoose-æ¨¡å¼è®¾è®¡-schema" tabindex="-1"><a class="header-anchor" href="#_3-mongoose-æ¨¡å¼è®¾è®¡-schema"><span>3. Mongoose æ¨¡å¼è®¾è®¡ (Schema)</span></a></h2><h3 id="_3-1-æ ‡å‡†-schema-å®šä¹‰" tabindex="-1"><a class="header-anchor" href="#_3-1-æ ‡å‡†-schema-å®šä¹‰"><span>3.1 æ ‡å‡† Schema å®šä¹‰</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;mongoose&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> userSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&#39;ç”¨æˆ·åä¸ºå¿…å¡«é¡¹&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// æ³¨æ„ï¼šunique ä¸æ˜¯éªŒè¯å™¨ï¼Œè€Œæ˜¯æ„å»ºå”¯ä¸€ç´¢å¼•çš„æŒ‡ä»¤</span></span>
<span class="line">    <span class="token literal-property property">trim</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token boolean">true</span>   <span class="token comment">// å¸¸ç”¨æŸ¥è¯¢å­—æ®µå»ºè®®åŠ ç´¢å¼•</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">email</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">match</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\\S+@\\S+\\.\\S+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&#39;é‚®ç®±æ ¼å¼ä¸æ­£ç¡®&#39;</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">role</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">enum</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;user&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;admin&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token string">&#39;user&#39;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token comment">// åµŒå¥—å¯¹è±¡</span></span>
<span class="line">  <span class="token literal-property property">profile</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> Number<span class="token punctuation">,</span> <span class="token literal-property property">min</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">bio</span><span class="token operator">:</span> String</span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token comment">// å¼•ç”¨å…¶ä»–é›†åˆ (å…³è”å…³ç³»)</span></span>
<span class="line">  <span class="token literal-property property">posts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">type</span><span class="token operator">:</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">ref</span><span class="token operator">:</span> <span class="token string">&#39;Post&#39;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">timestamps</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// è‡ªåŠ¨ç®¡ç† createdAt å’Œ updatedAt</span></span>
<span class="line">  <span class="token literal-property property">toJSON</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">virtuals</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// è¾“å‡º JSON æ—¶åŒ…å«è™šæ‹Ÿå±æ€§</span></span>
<span class="line">  <span class="token literal-property property">toObject</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">virtuals</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è™šæ‹Ÿå±æ€§ (ä¸ä¼šå­˜å…¥æ•°æ®åº“ï¼Œä½†èƒ½åƒå­—æ®µä¸€æ ·è®¿é—®)</span></span>
<span class="line">userSchema<span class="token punctuation">.</span><span class="token function">virtual</span><span class="token punctuation">(</span><span class="token string">&#39;isAdult&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>profile<span class="token punctuation">.</span>age <span class="token operator">&gt;=</span> <span class="token number">18</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&#39;User&#39;</span><span class="token punctuation">,</span> userSchema<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="_4-crud-æ“ä½œä¸æ€§èƒ½ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_4-crud-æ“ä½œä¸æ€§èƒ½ä¼˜åŒ–"><span>4. CRUD æ“ä½œä¸æ€§èƒ½ä¼˜åŒ–</span></a></h2><h3 id="_4-1-ğŸš€-æ€§èƒ½ä¼˜åŒ–çš„é»„é‡‘æ³•åˆ™-lean" tabindex="-1"><a class="header-anchor" href="#_4-1-ğŸš€-æ€§èƒ½ä¼˜åŒ–çš„é»„é‡‘æ³•åˆ™-lean"><span>4.1 ğŸš€ æ€§èƒ½ä¼˜åŒ–çš„é»„é‡‘æ³•åˆ™ï¼š<code>.lean()</code></span></a></h3><p>Mongoose é»˜è®¤è¿”å›çš„æ˜¯ &quot;Mongoose Document&quot; å¯¹è±¡ï¼ˆåŒ…å« <code>save</code>, <code>toObject</code> ç­‰å‡ ç™¾ä¸ªæ–¹æ³•ï¼‰ï¼Œéå¸¸æ¶ˆè€—å†…å­˜å’Œæ€§èƒ½ã€‚ <strong>å¦‚æœåœ¨åªè¯»åœºæ™¯ï¼ˆä¸éœ€è¦ä¿®æ”¹æ•°æ®ï¼‰ï¼ŒåŠ¡å¿…ä½¿ç”¨ <code>.lean()</code>ï¼Œæ€§èƒ½æå‡å¯è¾¾ 5-10 å€ã€‚</strong></p><h3 id="_4-2-è¯»å–æ“ä½œ-read" tabindex="-1"><a class="header-anchor" href="#_4-2-è¯»å–æ“ä½œ-read"><span>4.2 è¯»å–æ“ä½œ (Read)</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// âŒ æ…¢ï¼šè¿”å›å¤æ‚å¯¹è±¡</span></span>
<span class="line"><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">role</span><span class="token operator">:</span> <span class="token string">&#39;user&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// âœ… å¿«ï¼šè¿”å›çº¯ JS å¯¹è±¡ (POJO)</span></span>
<span class="line"><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">role</span><span class="token operator">:</span> <span class="token string">&#39;user&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&#39;username email&#39;</span><span class="token punctuation">)</span> <span class="token comment">// åªå–éœ€è¦çš„å­—æ®µ (Projection)</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">lean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line"></span>
<span class="line"><span class="token comment">// é€šè¿‡ ID æŸ¥è¯¢</span></span>
<span class="line"><span class="token comment">// æ³¨æ„ï¼šMongoose ä¼šè‡ªåŠ¨å°†å­—ç¬¦ä¸²è½¬ä¸º ObjectIdï¼Œæ— éœ€æ‰‹åŠ¨è½¬æ¢</span></span>
<span class="line"><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-å†™å…¥ä¸æ›´æ–°-create-update" tabindex="-1"><a class="header-anchor" href="#_4-3-å†™å…¥ä¸æ›´æ–°-create-update"><span>4.3 å†™å…¥ä¸æ›´æ–° (Create / Update)</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// åˆ›å»º</span></span>
<span class="line"><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">&#39;john_doe&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">email</span><span class="token operator">:</span> <span class="token string">&#39;john@example.com&#39;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ›´æ–° (æ¨è findByIdAndUpdate è€Œä¸æ˜¯ find -&gt; modify -&gt; saveï¼Œé™¤ééœ€è¦è§¦å‘ hook)</span></span>
<span class="line"><span class="token keyword">const</span> updatedUser <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findByIdAndUpdate</span><span class="token punctuation">(</span></span>
<span class="line">  id<span class="token punctuation">,</span> </span>
<span class="line">  <span class="token punctuation">{</span> <span class="token literal-property property">$set</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">&#39;profile.bio&#39;</span><span class="token operator">:</span> <span class="token string">&#39;New Bio&#39;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// ä½¿ç”¨ $set é¿å…è¦†ç›–æ•´ä¸ªå¯¹è±¡</span></span>
<span class="line">  <span class="token punctuation">{</span> </span>
<span class="line">    <span class="token keyword">new</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>          <span class="token comment">// è¿”å›æ›´æ–°åçš„æ–‡æ¡£</span></span>
<span class="line">    <span class="token literal-property property">runValidators</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// æ›´æ–°æ—¶ä¹Ÿæ‰§è¡Œ Schema éªŒè¯</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="_5-è¿›é˜¶ç‰¹æ€§-äº‹åŠ¡-transactions" tabindex="-1"><a class="header-anchor" href="#_5-è¿›é˜¶ç‰¹æ€§-äº‹åŠ¡-transactions"><span>5. è¿›é˜¶ç‰¹æ€§ï¼šäº‹åŠ¡ (Transactions)</span></a></h2><p>MongoDB 4.0+ æ”¯æŒå¤šæ–‡æ¡£ ACID äº‹åŠ¡ã€‚è¿™åœ¨æ¶‰åŠèµ„é‡‘ã€åº“å­˜ç­‰å¼ºä¸€è‡´æ€§åœºæ™¯ä¸‹æ˜¯å¿…é¡»çš„ã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;mongoose&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./models/User&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> Wallet <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./models/Wallet&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">transferMoney</span><span class="token punctuation">(</span><span class="token parameter">fromUserId<span class="token punctuation">,</span> toUserId<span class="token punctuation">,</span> amount</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token keyword">await</span> mongoose<span class="token punctuation">.</span><span class="token function">startSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  session<span class="token punctuation">.</span><span class="token function">startTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span> session <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 1. æ‰£æ¬¾</span></span>
<span class="line">    <span class="token keyword">const</span> sender <span class="token operator">=</span> <span class="token keyword">await</span> Wallet<span class="token punctuation">.</span><span class="token function">findOneAndUpdate</span><span class="token punctuation">(</span></span>
<span class="line">      <span class="token punctuation">{</span> <span class="token literal-property property">userId</span><span class="token operator">:</span> fromUserId <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span> <span class="token literal-property property">$inc</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">balance</span><span class="token operator">:</span> <span class="token operator">-</span>amount <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      opts</span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>sender<span class="token punctuation">.</span>balance <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;ä½™é¢ä¸è¶³&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// æŠ›å‡ºé”™è¯¯ä¼šè‡ªåŠ¨è§¦å‘ catch ä¸­çš„ abortTransaction</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 2. åŠ æ¬¾</span></span>
<span class="line">    <span class="token keyword">await</span> Wallet<span class="token punctuation">.</span><span class="token function">findOneAndUpdate</span><span class="token punctuation">(</span></span>
<span class="line">      <span class="token punctuation">{</span> <span class="token literal-property property">userId</span><span class="token operator">:</span> toUserId <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">{</span> <span class="token literal-property property">$inc</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">balance</span><span class="token operator">:</span> amount <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      opts</span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 3. æäº¤äº‹åŠ¡</span></span>
<span class="line">    <span class="token keyword">await</span> session<span class="token punctuation">.</span><span class="token function">commitTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;è½¬è´¦æˆåŠŸ&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 4. å›æ»šäº‹åŠ¡</span></span>
<span class="line">    <span class="token keyword">await</span> session<span class="token punctuation">.</span><span class="token function">abortTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;è½¬è´¦å¤±è´¥ï¼Œå·²å›æ»š:&#39;</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span></span>
<span class="line">    session<span class="token punctuation">.</span><span class="token function">endSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="_6-å¸¸è§å‘ç‚¹ä¸è§£å†³æ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#_6-å¸¸è§å‘ç‚¹ä¸è§£å†³æ–¹æ¡ˆ"><span>6. å¸¸è§å‘ç‚¹ä¸è§£å†³æ–¹æ¡ˆ</span></a></h2><h3 id="_6-1-objectid-çš„é™·é˜±" tabindex="-1"><a class="header-anchor" href="#_6-1-objectid-çš„é™·é˜±"><span>6.1 ObjectId çš„é™·é˜±</span></a></h3><ul><li><p><strong>åŸç”Ÿé©±åŠ¨ (Native Driver)</strong>: å¿…é¡»æ‰‹åŠ¨è½¬æ¢å­—ç¬¦ä¸² IDã€‚</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> ObjectId <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;mongodb&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// å¿…é¡»è¿™æ ·å†™ï¼Œå¦åˆ™æŸ¥ä¸åˆ°</span></span>
<span class="line">db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">&#39;users&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ObjectId</span><span class="token punctuation">(</span><span class="token string">&#39;64bf...&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>Mongoose</strong>: è‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€æ‰‹åŠ¨è½¬æ¢</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">User<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token string">&#39;64bf...&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è‡ªåŠ¨å¤„ç†</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ul><h3 id="_6-2-æ•°ç»„æŸ¥è¯¢" tabindex="-1"><a class="header-anchor" href="#_6-2-æ•°ç»„æŸ¥è¯¢"><span>6.2 æ•°ç»„æŸ¥è¯¢</span></a></h3><ul><li><code>{ tags: &quot;js&quot; }</code>: æ•°ç»„ä¸­<strong>åŒ…å«</strong> &quot;js&quot; å³åŒ¹é…ï¼ˆæœ€å¸¸ç”¨ï¼‰ã€‚</li><li><code>{ tags: [&quot;js&quot;, &quot;node&quot;] }</code>: æ•°ç»„<strong>ä¸¥æ ¼ç­‰äº</strong> <code>[&quot;js&quot;, &quot;node&quot;]</code>ï¼ˆé¡ºåºå’Œæ•°é‡éƒ½å¿…é¡»ä¸€è‡´ï¼‰ã€‚</li><li><code>{ tags: { $all: [&quot;js&quot;, &quot;node&quot;] } }</code>: æ•°ç»„<strong>åŒ…å«</strong> &quot;js&quot; å’Œ &quot;node&quot;ï¼ˆé¡ºåºæ— å…³ï¼‰ã€‚</li></ul><h3 id="_6-3-å”¯ä¸€ç´¢å¼•-unique-index" tabindex="-1"><a class="header-anchor" href="#_6-3-å”¯ä¸€ç´¢å¼•-unique-index"><span>6.3 å”¯ä¸€ç´¢å¼• (Unique Index)</span></a></h3><p>å¦‚æœåœ¨ Schema ä¸­æ·»åŠ äº† <code>unique: true</code> ä½†ä¸ç”Ÿæ•ˆï¼Œé€šå¸¸æ˜¯å› ä¸ºé›†åˆä¸­å·²ç»å­˜åœ¨é‡å¤æ•°æ®ã€‚ä½ éœ€è¦å…ˆæ¸…ç†è„æ•°æ®ï¼Œç„¶åæ‰‹åŠ¨é‡å»ºç´¢å¼•ï¼š</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">syncIndexes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h2 id="_7-ç°ä»£åŒ–å¼€å‘-typescript-æ”¯æŒ" tabindex="-1"><a class="header-anchor" href="#_7-ç°ä»£åŒ–å¼€å‘-typescript-æ”¯æŒ"><span>7. ç°ä»£åŒ–å¼€å‘ï¼šTypeScript æ”¯æŒ</span></a></h2><p>å¦‚æœä½ åœ¨ä½¿ç”¨ TypeScriptï¼ˆå¼ºçƒˆæ¨èï¼‰ï¼ŒMongoose ç°åœ¨æä¾›äº†å¾ˆå¥½çš„ç±»å‹æ¨æ–­ã€‚</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> mongoose<span class="token punctuation">,</span> <span class="token punctuation">{</span> Schema<span class="token punctuation">,</span> InferSchemaType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;mongoose&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> userSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  name<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> String<span class="token punctuation">,</span> required<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  email<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> String<span class="token punctuation">,</span> required<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  age<span class="token operator">:</span> Number</span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è‡ªåŠ¨ä» Schema æ¨æ–­ TS ç±»å‹ï¼Œæ— éœ€æ‰‹åŠ¨å®šä¹‰ interface</span></span>
<span class="line"><span class="token class-name"><span class="token keyword">type</span></span> UserType <span class="token operator">=</span> InferSchemaType<span class="token operator">&lt;</span><span class="token keyword">typeof</span> userSchema<span class="token operator">&gt;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> User <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&#39;User&#39;</span><span class="token punctuation">,</span> userSchema<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// user å˜é‡ä¼šè‡ªåŠ¨è·å¾—ç±»å‹æç¤º</span></span>
<span class="line">  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&#39;Alice&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// TS çŸ¥é“è¿™é‡Œæœ‰ email å­—æ®µ</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-å®‰å…¨æ€§æ£€æŸ¥æ¸…å•" tabindex="-1"><a class="header-anchor" href="#_8-å®‰å…¨æ€§æ£€æŸ¥æ¸…å•"><span>8. å®‰å…¨æ€§æ£€æŸ¥æ¸…å•</span></a></h2><ol><li><strong>ä¸è¦å°† MongoDB æš´éœ²åœ¨å…¬ç½‘</strong>ï¼šåœ¨ <code>mongod.conf</code> ä¸­è®¾ç½® <code>bindIp: 127.0.0.1</code> æˆ–ä½¿ç”¨é˜²ç«å¢™ã€‚</li><li><strong>å¯ç”¨è®¤è¯</strong>ï¼šå§‹ç»ˆå¼€å¯ Authenticationï¼Œåˆ›å»º root ç”¨æˆ·å’Œä¸šåŠ¡æ•°æ®åº“çš„ä¸“å±ç”¨æˆ·ã€‚</li><li><strong>é˜²æ­¢ NoSQL æ³¨å…¥</strong>ï¼š <ul><li>å¦‚æœæ˜¯ä½¿ç”¨ <code>express</code>ï¼Œä¸è¦ç›´æ¥å°† <code>req.body</code> ä¼ å…¥æŸ¥è¯¢æ¡ä»¶ã€‚</li><li>æ¶æ„ç”¨æˆ·å¯èƒ½å‘é€ <code>{ &quot;username&quot;: { &quot;$gt&quot;: &quot;&quot; } }</code> æ¥ç»•è¿‡ç™»å½•ã€‚</li><li><strong>è§£å†³</strong>ï¼šä½¿ç”¨ <code>express-mongo-sanitize</code> ä¸­é—´ä»¶ã€‚</li></ul></li></ol><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token function">npm</span> <span class="token function">install</span> express-mongo-sanitize</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> mongoSanitize <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;express-mongo-sanitize&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">mongoSanitize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç§»é™¤ req.body ä¸­çš„ $ ç¬¦å·</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“"><span>æ€»ç»“</span></a></h2><p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ MongoDB + Node.jsï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ï¼š</p><ol><li><strong>è¿æ¥ç®¡ç†</strong>ï¼šä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼Œåœ¨åº”ç”¨å¯åŠ¨æ—¶è¿æ¥ä¸€æ¬¡</li><li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šå……åˆ†åˆ©ç”¨ <code>.lean()</code> å’Œç´¢å¼•æ¥æå‡æŸ¥è¯¢æ€§èƒ½</li><li><strong>æ•°æ®å®‰å…¨</strong>ï¼šå¯ç”¨è®¤è¯ï¼Œé˜²æ­¢ NoSQL æ³¨å…¥</li><li><strong>äº‹åŠ¡æ”¯æŒ</strong>ï¼šåœ¨éœ€è¦å¼ºä¸€è‡´æ€§çš„åœºæ™¯ä½¿ç”¨äº‹åŠ¡</li><li><strong>ç±»å‹å®‰å…¨</strong>ï¼šæ¨èä½¿ç”¨ TypeScript æå‡å¼€å‘ä½“éªŒ</li></ol><p>éµå¾ªè¿™äº›æœ€ä½³å®è·µï¼Œå¯ä»¥æ„å»ºå‡ºé«˜æ€§èƒ½ã€å®‰å…¨å¯é çš„ MongoDB åº”ç”¨ã€‚</p><hr>`,53)),s("blockquote",null,[n[3]||(n[3]=s("p",null,[a("ğŸ’¡ "),s("strong",null,"ç›¸å…³èµ„æº"),a("ï¼š")],-1)),s("ul",null,[n[1]||(n[1]=s("li",null,[s("a",{href:"https://www.mongodb.com/docs/",target:"_blank",rel:"noopener noreferrer"},"MongoDB å®˜æ–¹æ–‡æ¡£")],-1)),n[2]||(n[2]=s("li",null,[s("a",{href:"https://mongoosejs.com/docs/",target:"_blank",rel:"noopener noreferrer"},"Mongoose å®˜æ–¹æ–‡æ¡£")],-1)),s("li",null,[p(t,{to:"/posts/nodejs/MongoDB%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8.html"},{default:u(()=>[...n[0]||(n[0]=[a("MongoDB å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥è¡¨",-1)])]),_:1})])])]),p(o),n[5]||(n[5]=s("hr",null,null,-1)),n[6]||(n[6]=s("p",null,[s("strong",null,"å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–æƒ³åˆ†äº«ä½ çš„ MongoDB ä½¿ç”¨ç»éªŒï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºäº¤æµï¼")],-1))])}const b=l(d,[["render",k]]),g=JSON.parse('{"path":"/posts/nodejs/Node.js-MongoDB%E6%95%B0%E6%8D%AE%E5%BA%93.html","title":"Node.js + MongoDB ç”Ÿäº§çº§æœ€ä½³å®è·µæŒ‡å—","lang":"zh-CN","frontmatter":{"title":"Node.js + MongoDB ç”Ÿäº§çº§æœ€ä½³å®è·µæŒ‡å—","date":"2025-11-22T00:00:00.000Z","categories":["Node.js æ·±å…¥å­¦ä¹ "],"tags":["Node.js","MongoDB","æ•°æ®åº“","Mongoose"]},"git":{"updatedTime":1765046795000,"contributors":[{"name":"52nnnn","username":"52nnnn","email":"2764304248@qq.com","commits":3,"url":"https://github.com/52nnnn"},{"name":"Claude","username":"Claude","email":"noreply@anthropic.com","commits":2,"url":"https://github.com/Claude"}],"changelog":[{"hash":"82b916bca35f631eed19f39ea2df3af77f5312e6","time":1765046795000,"email":"2764304248@qq.com","author":"52nnnn","message":"å¢åŠ ä½œå“"},{"hash":"0d0d0a0cd900f97da13cc6102c1b88b20855dbba","time":1763817139000,"email":"2764304248@qq.com","author":"52nnnn","message":"fix: ä¿®å¤MongoDBæ–‡æ¡£æ ¼å¼é—®é¢˜å¹¶å®Œå–„å†…å®¹","coAuthors":[{"name":"Claude","email":"noreply@anthropic.com"}]},{"hash":"6ed236e441ae5cfe1b0c306c713a231ed7ebc9fd","time":1763805959000,"email":"2764304248@qq.com","author":"52nnnn","message":"docs: æ•´åˆæ ¹ç›®å½•æ–‡æ¡£åˆ°åšå®¢æŒ‡å—","coAuthors":[{"name":"Claude","email":"noreply@anthropic.com"}]}]},"filePathRelative":"posts/nodejs/Node.js-MongoDBæ•°æ®åº“.md"}');export{b as comp,g as data};
